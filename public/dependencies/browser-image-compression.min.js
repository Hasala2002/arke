!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e=e||self).imageCompression=n()}(this,function(){"use strict";function n(n,e){var t,r=Object.keys(n);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(n),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),r.push.apply(r,t)),r}function g(r){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?n(Object(i),!0).forEach(function(e){var n,t;n=r,e=i[t=e],t in n?Object.defineProperty(n,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):n[t]=e}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(i,e))})}return r}function x(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var t=[],r=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(r=(a=s.next()).done)&&(t.push(a.value),!n||t.length!==n);r=!0);}catch(e){i=!0,o=e}finally{try{r||null==s.return||s.return()}finally{if(i)throw o}}return t}}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var e="undefined"!=typeof window,t=e&&window.cordova&&window.cordova.require&&window.cordova.require("cordova/modulemapper"),d=e&&(t&&t.getOriginalSymbol(window,"File")||File),i=e&&(t&&t.getOriginalSymbol(window,"FileReader")||FileReader);function s(r){return new Promise(function(e,n){var t=new i;t.onload=function(){return e(t.result)},t.onerror=function(e){return n(e)},t.readAsDataURL(r)})}function u(a,s){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:Date.now();return new Promise(function(e){for(var n=a.split(","),t=n[0].match(/:(.*?);/)[1],r=atob(n[1]),i=r.length,o=new Uint8Array(i);i--;)o[i]=r.charCodeAt(i);t=new Blob([o],{type:t});t.name=s,t.lastModified=c,e(t)})}function c(r){return new Promise(function(e,n){var t=new Image;t.onload=function(){return e(t)},t.onerror=function(e){return n(e)},t.src=r})}function l(e){var n=x(j(e.width,e.height),2),t=n[0];return n[1].drawImage(e,0,0,t.width,t.height),t}function r(a){return new Promise(function(e,n){function t(e){try{return s(a).then(function(e){try{return c(e).then(function(e){try{return r=e,o()}catch(e){return n(e)}},n)}catch(e){return n(e)}},n)}catch(e){return n(e)}}var r,i,o=function(){try{return i=l(r),e([r,i])}catch(e){return n(e)}};try{return createImageBitmap(a).then(function(e){try{return r=e,o()}catch(e){return t()}},t)}catch(e){t()}})}function U(i,o,a,s){var c=4<arguments.length&&void 0!==arguments[4]?arguments[4]:1;return new Promise(function(e,n){var t;return"function"==typeof OffscreenCanvas&&i instanceof OffscreenCanvas?i.convertToBlob({type:o,quality:c}).then(function(e){try{return(t=e).name=a,t.lastModified=s,r.call(this)}catch(e){return n(e)}}.bind(this),n):u(i.toDataURL(o,c),a,s).then(function(e){try{return t=e,r.call(this)}catch(e){return n(e)}}.bind(this),n);function r(){return e(t)}})}function M(t){return new Promise(function(c,n){var e=new i;e.onload=function(e){var n=new DataView(e.target.result);if(65496!=n.getUint16(0,!1))return c(-2);for(var t=n.byteLength,r=2;r<t;){if(n.getUint16(r+2,!1)<=8)return c(-1);var i=n.getUint16(r,!1);if(r+=2,65505==i){if(1165519206!=n.getUint32(r+=2,!1))return c(-1);var o=18761==n.getUint16(r+=6,!1);r+=n.getUint32(r+4,o);var a=n.getUint16(r,o);r+=2;for(var s=0;s<a;s++)if(274==n.getUint16(r+12*s,o))return c(n.getUint16(r+12*s+8,o))}else{if(65280!=(65280&i))break;r+=n.getUint16(r,!1)}}return c(-1)},e.onerror=function(e){return n(e)},e.readAsArrayBuffer(t)})}function P(e,n){var t=e.width,r=e.height,i=n.maxWidthOrHeight,o=e;return Number.isFinite(i)&&(i<t||i<r)&&(o=(n=x(j(t,r),2))[0],n=n[1],r<t?(o.width=i,o.height=r/t*i):(o.width=t/r*i,o.height=i),n.drawImage(e,0,0,o.width,o.height),k(e)),o}function E(e,n){var t=e.width,r=e.height,i=x(j(t,r),2),o=i[0],a=i[1];switch(4<n&&n<9?(o.width=r,o.height=t):(o.width=t,o.height=r),n){case 2:a.transform(-1,0,0,1,t,0);break;case 3:a.transform(-1,0,0,-1,t,r);break;case 4:a.transform(1,0,0,-1,0,r);break;case 5:a.transform(0,1,1,0,0,0);break;case 6:a.transform(0,1,-1,0,r,0);break;case 7:a.transform(0,-1,-1,0,r,t);break;case 8:a.transform(0,-1,1,0,0,t)}return a.drawImage(e,0,0,t,r),k(e),o}function j(e,n){var t,r;try{if(null===(r=(t=new OffscreenCanvas(e,n)).getContext("2d")))throw new Error("getContext of OffscreenCanvas returns null")}catch(e){r=(t=document.createElement("canvas")).getContext("2d")}return t.width=e,t.height=n,[t,r]}function k(e){e.width=0,e.height=0}function h(F,I){return new Promise(function(i,o){var n,a,s,c,u,f,l,m,g,d,h,p,w,y,v,b;function C(e){n+=0<arguments.length&&void 0!==e?e:5,"function"==typeof I.onProgress&&I.onProgress(Math.min(n,100))}function O(e){n=Math.min(Math.max(e,n),100),"function"==typeof I.onProgress&&I.onProgress(n)}return n=0,a=I.maxIteration||10,s=1024*I.maxSizeMB*1024,C(),r(F).then(function(e){try{var n=x(e,2);return n[0],c=n[1],C(),u=P(c,I),C(),new Promise(function(e,n){var t;return(t=I.exifOrientation)?r.call(this):M(F).then(function(e){try{return t=e,r.call(this)}catch(e){return n(e)}}.bind(this),n);function r(){return e(t)}}).then(function(e){try{return I.exifOrientation=e,C(),f=E(u,I.exifOrientation),C(),l=1,U(f,I.fileType||F.type,F.name,F.lastModified,l).then(function(e){try{return(m=e,C(),g=m.size>s,d=m.size>F.size,g||d)?(h=F.size,p=m.size,w=p,b=f,(n=function(e){for(;e;){if(e.then)return void e.then(n,o);try{if(e.pop){if(e.length)return e.pop()?t.call(this):e;e=r}else e=e.call(this)}catch(e){return o(e)}}}.bind(this))(r)):(O(100),i(m));var n;function r(){if(a--&&(s<w||h<w)){var e,n,t=x(j(e=g?.95*b.width:b.width,n=g?.95*b.height:b.height),2);return v=t[0],t[1].drawImage(b,0,0,e,n),"image/jpeg"===F.type&&(l*=.95),U(v,I.fileType||F.type,F.name,F.lastModified,l).then(function(e){try{return y=e,k(b),b=v,w=y.size,O(Math.min(99,Math.floor((p-w)/(p-s)*100))),r}catch(e){return o(e)}},o)}return[1]}function t(){return k(b),k(v),k(u),k(f),k(c),O(100),i(y)}}catch(e){return o(e)}}.bind(this),o)}catch(e){return o(e)}}.bind(this),o)}catch(e){return o(e)}}.bind(this),o)})}e&&(Number.isInteger=Number.isInteger||function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e});var p,w,y=0;function v(l,m){return new Promise(function(e,n){var t,r,i;if(m.maxSizeMB=m.maxSizeMB||Number.POSITIVE_INFINITY,r="boolean"==typeof m.useWebWorker&&m.useWebWorker,delete m.useWebWorker,!(l instanceof Blob||l instanceof d))return n(new Error("The file given is not an instance of Blob or File"));if(!/^image/.test(l.type))return n(new Error("The file given is not an image"));if(i="undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,!r||"function"!=typeof Worker||i)return h(l,m).then(function(e){try{return t=e,u.call(this)}catch(e){return n(e)}}.bind(this),n);function o(e){try{return h(l,m).then(function(e){try{return t=e,c()}catch(e){return n(e)}},n)}catch(e){return n(e)}}var a,s,c=function(){try{return u.call(this)}catch(e){return n(e)}}.bind(this);try{return a=l,s=m,new Promise(function(i,o){return new Promise(function(e,n){var t,r=y++;return p||(t="\n    function imageCompression (){return (".concat(v,").apply(null, arguments)}\n\n    imageCompression.getDataUrlFromFile = ").concat(v.getDataUrlFromFile,"\n    imageCompression.getFilefromDataUrl = ").concat(v.getFilefromDataUrl,"\n    imageCompression.loadImage = ").concat(v.loadImage,"\n    imageCompression.drawImageInCanvas = ").concat(v.drawImageInCanvas,"\n    imageCompression.drawFileInCanvas = ").concat(v.drawFileInCanvas,"\n    imageCompression.canvasToFile = ").concat(v.canvasToFile,"\n    imageCompression.getExifOrientation = ").concat(v.getExifOrientation,"\n    imageCompression.handleMaxWidthOrHeight = ").concat(v.handleMaxWidthOrHeight,"\n    imageCompression.followExifOrientation = ").concat(v.followExifOrientation,"\n    imageCompression.cleanupMemory = ").concat(v.cleanupMemory,"\n\n    getDataUrlFromFile = imageCompression.getDataUrlFromFile\n    getFilefromDataUrl = imageCompression.getFilefromDataUrl\n    loadImage = imageCompression.loadImage\n    drawImageInCanvas = imageCompression.drawImageInCanvas\n    drawFileInCanvas = imageCompression.drawFileInCanvas\n    canvasToFile = imageCompression.canvasToFile\n    getExifOrientation = imageCompression.getExifOrientation\n    handleMaxWidthOrHeight = imageCompression.handleMaxWidthOrHeight\n    followExifOrientation = imageCompression.followExifOrientation\n    cleanupMemory = imageCompression.cleanupMemory\n\n    getNewCanvasAndCtx = ").concat(j,"\n    \n    CustomFileReader = FileReader\n    \n    CustomFile = File\n    \n    function _slicedToArray(arr, n) { return arr }\n    \n    function _typeof(a) { return typeof a }\n\n    function compress (){return (").concat(h,").apply(null, arguments)}\n    "),p=URL.createObjectURL(new Blob([t],{type:"application/javascript"}))),w||("function"==typeof(t="\n    let scriptImported = false\n    self.addEventListener('message', async (e) => {\n      const { file, id, imageCompressionLibUrl, options } = e.data\n      options.onProgress = (progress) => self.postMessage({ progress, id })\n      try {\n        if (!scriptImported) {\n          // console.log('[worker] importScripts', imageCompressionLibUrl)\n          self.importScripts(imageCompressionLibUrl)\n          scriptImported = true\n        }\n        // console.log('[worker] self', self)\n        const compressedFile = await imageCompression(file, options)\n        self.postMessage({ file: compressedFile, id })\n      } catch (e) {\n        // console.error('[worker] error', e)\n        self.postMessage({ error: e.message + '\\n' + e.stack, id })\n      }\n    })\n  ")&&(t="(".concat(f,")()")),w=new Worker(URL.createObjectURL(new Blob([t])))),w.addEventListener("message",function e(n){n.data.id===r&&(void 0!==n.data.progress&&n.data.progress<100?s.onProgress(n.data.progress):(w.removeEventListener("message",e),n.data.error&&o(new Error(n.data.error)),i(n.data.file)))}),w.postMessage({file:a,id:r,imageCompressionLibUrl:p,options:g({},s,{onProgress:void 0})}),e()})}).then(function(e){try{return t=e,c()}catch(e){return o()}},o)}catch(e){o()}function u(){try{t.name=l.name,t.lastModified=l.lastModified}catch(e){}return e(t)}})}return v.getDataUrlFromFile=s,v.getFilefromDataUrl=u,v.loadImage=c,v.drawImageInCanvas=l,v.drawFileInCanvas=r,v.canvasToFile=U,v.getExifOrientation=M,v.handleMaxWidthOrHeight=P,v.followExifOrientation=E,v.cleanupMemory=k,v.version="1.0.9",v});